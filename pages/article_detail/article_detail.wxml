<!--pages/article_detail/article_detail.wxml-->
<wxs module="utils">
  function formatTime(seconds) {
    if (!seconds || isNaN(seconds)) return '00:00';
    var mins = Math.floor(seconds / 60);
    var secs = Math.floor(seconds % 60);
    var minStr = mins < 10 ? '0' + mins : mins.toString();
    var secStr = secs < 10 ? '0' + secs : secs.toString();
    return minStr + ':' + secStr;
  }
  
  module.exports = {
    formatTime: formatTime
  };
</wxs>

<view class="article-container">
  <!-- Star background animation -->
  <view class="star-bg"></view>
  
  <!-- æ•´ä½“æ»šåŠ¨å®¹å™¨ -->
  <scroll-view scroll-y class="main-scroll-view">
    <!-- Article header with cover -->
    <view class="article-header">
      <view class="header-content">
        <view class="cover-container">
          <image class="article-cover" 
                 src="{{article.coverUrl}}" 
                 mode="aspectFill"
                 wx:if="{{article.coverUrl}}"
                 binderror="handleCoverError"
                 lazy-load="{{true}}"></image>
          <!-- æ ‡é¢˜å åŠ åœ¨å›¾ç‰‡åº•éƒ¨ -->
          <view class="title-overlay">
            <view class="article-title">{{article.title}}</view>
          </view>
        </view>
        <view class="article-info">
          <view class="article-meta">
            <text class="article-date">{{article.date}}</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- Control bar -->
    <view class="control-bar">
      <view class="button-row">
        <!-- æ‰€æœ‰æŒ‰é’®ç»Ÿä¸€æ”¾åœ¨ä¸€èµ· -->
        <view class="left-buttons">
          <view class="action-btn read-btn" bindtap="toggleBgm" hover-class="hover">
            <text class="icon-read">â™ª</text>
          </view>
          <view class="action-btn bookmark-btn {{isBookmarked ? 'bookmarked' : ''}}" bindtap="bookmarkArticle" hover-class="hover">
            <text class="icon-bookmark">{{isBookmarked ? 'â˜…' : 'â˜†'}}</text>
          </view>
          <view class="action-btn print-btn" bindtap="printArticle" hover-class="hover">
            <text class="icon-print">ğŸ–¨ï¸</text>
          </view>
          <view class="action-btn exercise-btn" bindtap="showExercises" hover-class="hover">
            <text class="icon-exercise">ğŸ“</text>
          </view>
          <view class="action-btn font-decrease-btn" bindtap="decreaseFontSize" hover-class="hover">
            <text>A-</text>
          </view>
          <view class="action-btn font-increase-btn" bindtap="increaseFontSize" hover-class="hover">
            <text>A+</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- æ€è€ƒé¢˜æ¡† -->
    <view class="thinking-question-box">
      <view class="thinking-question-header">
        <text class="thinking-icon">ğŸ’­</text>
        <text class="thinking-title">æ€è€ƒ</text>
      </view>
      <view class="thinking-question-content">
        <text class="question-text">{{article.thinkingQuestion || 'é€šè¿‡é˜…è¯»æœ¬æ–‡ï¼Œä½ è®¤ä¸ºäººç±»æ¢ç´¢å®‡å®™çš„æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿæœªæ¥çš„å¤ªç©ºæ¢ç´¢ä¼šç»™æˆ‘ä»¬å¸¦æ¥å“ªäº›æ”¹å˜ï¼Ÿ'}}</text>
      </view>
      <view class="thinking-question-tips">
        <text class="tips-text">å°æç¤º: æ€è€ƒè¿™ä¸ªé—®é¢˜å¯ä»¥å¸®åŠ©ä½ æ›´æ·±å…¥åœ°ç†è§£æ–‡ç« å†…å®¹</text>
      </view>
    </view>
    
          <!-- ç¿»é¡µå®¹å™¨ - 3Dä¹¦é¡µå †å  -->
          <view class="content-swiper">
            <!-- é¡µé¢3ï¼šç»“è®ºï¼ˆæœ€åº•å±‚ï¼‰-->
            <view 
              wx:if="{{article.conclusionNodes || (article.conclusionImages && article.conclusionImages.length > 0)}}"
              class="page-layer page-layer-3 {{currentPage > 2 ? 'flipped' : ''}} {{currentPage === 2 ? 'active-page' : 'inactive-page'}}"
              style="{{page3Style}}"
              bindtouchstart="onPageTouchStart"
              bindtouchmove="onPageTouchMove"
              bindtouchend="onPageTouchEnd">
              <view class="page-content">
                <view class="page-number-corner">3</view>
                <view class="section-header-bar">
                  <view class="section-badge">ç»“è®º</view>
                  <view class="section-line"></view>
                </view>
                <view class="content-box conclusion-box" wx:if="{{article.conclusionNodes}}">
                  <rich-text nodes="{{article.conclusionNodes}}" class="rich-content"></rich-text>
                </view>
                <view class="image-group" wx:if="{{article.conclusionImages && article.conclusionImages.length > 0}}">
                  <block wx:for="{{article.conclusionImages}}" wx:key="url">
                    <image 
                      src="{{item.url}}"
                      mode="widthFix"
                      class="content-image"
                      lazy-load="true"
                      bindtap="previewImage"
                      data-url="{{item.url}}"
                    ></image>
                    <view class="image-desc-box">{{item.description}}</view>
                  </block>
                </view>
                <!-- åº•éƒ¨å ä½ï¼Œé¿å…è¢«éŸ³é¢‘æ’­æ”¾å™¨é®æŒ¡ -->
                <view class="page-bottom-spacer"></view>
              </view>
            </view>

            <!-- é¡µé¢2ï¼šæ­£æ–‡ï¼ˆä¸­é—´å±‚ï¼‰-->
            <view 
              wx:if="{{article.contentNodes || (article.contentImages && article.contentImages.length > 0)}}"
              class="page-layer page-layer-2 {{currentPage > 1 ? 'flipped' : ''}} {{isFlipping && currentPage === 1 ? 'flipping' : ''}} {{currentPage === 1 ? 'active-page' : 'inactive-page'}}"
              style="{{page2Style}}"
              bindtouchstart="onPageTouchStart"
              bindtouchmove="onPageTouchMove"
              bindtouchend="onPageTouchEnd">
              <view class="page-content">
                <view class="page-number-corner">2</view>
                <view class="section-header-bar">
                  <view class="section-badge">æ­£æ–‡</view>
                  <view class="section-line"></view>
                </view>
                <view class="content-box main-content-box" wx:if="{{article.contentNodes}}">
                  <rich-text nodes="{{article.contentNodes}}" class="rich-content"></rich-text>
                </view>
                <view class="image-group" wx:if="{{article.contentImages && article.contentImages.length > 0}}">
                  <block wx:for="{{article.contentImages}}" wx:key="url">
                    <image 
                      src="{{item.url}}"
                      mode="widthFix"
                      class="content-image"
                      lazy-load="true"
                      bindtap="previewImage"
                      data-url="{{item.url}}"
                    ></image>
                    <view class="image-desc-box">{{item.description}}</view>
                  </block>
                </view>
                <!-- åº•éƒ¨å ä½ï¼Œé¿å…è¢«éŸ³é¢‘æ’­æ”¾å™¨é®æŒ¡ -->
                <view class="page-bottom-spacer"></view>
              </view>
            </view>

            <!-- é¡µé¢1ï¼šå¼•è¨€ï¼ˆæœ€ä¸Šå±‚ï¼Œåƒå°é¢ï¼‰-->
            <view 
              wx:if="{{article.introNodes || (article.introImages && article.introImages.length > 0)}}"
              class="page-layer page-layer-1 {{currentPage > 0 ? 'flipped' : ''}} {{isFlipping && currentPage === 0 ? 'flipping' : ''}} {{currentPage === 0 ? 'active-page' : 'inactive-page'}}"
              style="{{page1Style}}"
              bindtouchstart="onPageTouchStart"
              bindtouchmove="onPageTouchMove"
              bindtouchend="onPageTouchEnd">
              <view class="page-content">
                <view class="page-number-corner">1</view>
                <view class="section-header-bar">
                  <view class="section-badge">å¼•è¨€</view>
                  <view class="section-line intro-line">
                    <view class="intro-line-rail"></view>
                    <text class="line-tip">å‘å·¦æ»‘ç¿»é¡µ</text>
                  </view>
                </view>
                <view class="content-box intro-box" wx:if="{{article.introNodes}}">
                  <rich-text nodes="{{article.introNodes}}" class="rich-content"></rich-text>
                </view>
                <view class="image-group" wx:if="{{article.introImages && article.introImages.length > 0}}">
                  <block wx:for="{{article.introImages}}" wx:key="url">
                    <image 
                      src="{{item.url}}"
                      mode="widthFix"
                      class="content-image"
                      lazy-load="true"
                      bindtap="previewImage"
                      data-url="{{item.url}}"
                    ></image>
                    <view class="image-desc-box">{{item.description}}</view>
                  </block>
                </view>
                <!-- åº•éƒ¨å ä½ï¼Œé¿å…è¢«éŸ³é¢‘æ’­æ”¾å™¨é®æŒ¡ -->
                <view class="page-bottom-spacer"></view>
              </view>
            </view>
          </view>
    
    <view class="content-bottom-spacer"></view>
  </scroll-view>
  
  <!-- å›ºå®šåœ¨åº•éƒ¨çš„æœ—è¯»æ’­æ”¾å™¨ -->
  <view class="audio-player-fixed" wx:if="{{article.voice}}">
    <view class="audio-player-header">
      <text class="audio-title">ğŸ§ æ–‡ç« æœ—è¯»</text>
    </view>
    <view class="audio-controls">
      <view class="audio-info">
        <text class="audio-status">{{article.title}}</text>
      </view>
      <view class="audio-buttons">
        <view class="speed-btn" bindtap="togglePlaybackRate">
          <text class="speed-text">{{playbackRate}}x</text>
        </view>
        <view class="play-btn {{isReading ? 'playing' : ''}}" bindtap="toggleReading">
          <view class="play-icon {{isReading ? 'pause' : 'triangle'}}">
            <view class="bar left"></view>
            <view class="bar right"></view>
          </view>
        </view>
      </view>
    </view>
    <view class="audio-progress">
      <text class="time-text">{{utils.formatTime(audioCurrentTime)}}</text>
      <view class="progress-container">
        <view class="progress-bar">
          <view class="progress-bg"></view>
          <view class="progress-fill" style="width: {{audioProgress}}%"></view>
          <view class="progress-thumb" style="left: {{audioProgress}}%"></view>
        </view>
      </view>
      <text class="time-text">{{utils.formatTime(audioDuration)}}</text>
    </view>
  </view>
  
  <!-- æ‚¬æµ®çš„äº²å­è®¨è®ºå®ç®±æŒ‰é’® -->
  <view class="discussion-float-btn"
        style="left: {{floatBtnX}}px; top: {{floatBtnY}}px;"
        catchtouchstart="onFloatTouchStart"
        catchtouchmove="onFloatTouchMove"
        catchtouchend="onFloatTouchEnd">
    <view class="treasure-box-icon">
      <image class="box-icon-img" src="icon/key.png" mode="aspectFit"></image>
    </view>
    <text class="float-btn-text">è®¨è®º</text>
  </view>

  <!-- äº²å­è®¨è®ºå¼¹çª— -->
  <view class="discussion-overlay" wx:if="{{showDiscussionBox}}" catchtap="closeDiscussionBox">
    <view class="discussion-content" catchtap="stopPropagation">
      <view class="discussion-header">
        <image class="discussion-icon" src="icon/treasure.png" mode="aspectFit"></image>
        <text class="discussion-title">äº²å­è®¨è®ºäº’åŠ¨</text>
        <view class="close-btn" bindtap="closeDiscussionBox">
          <text>âœ•</text>
        </view>
      </view>
      <view class="discussion-body">
        <view class="discussion-subtitle">ä¸€èµ·æ¢ç´¢è¿™äº›é—®é¢˜å§~</view>
        <view class="discussion-questions">
          <view class="question-item" wx:for="{{discussionQuestions}}" wx:key="index">
            <view class="question-number">{{index + 1}}</view>
            <text class="question-text">{{item}}</text>
          </view>
        </view>
        <view class="discussion-tips">
          <text class="tips-content">æç¤ºï¼šæ²¡æœ‰æ ‡å‡†ç­”æ¡ˆï¼Œé¼“åŠ±è‡ªç”±è¡¨è¾¾æƒ³æ³•</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ä¼šå‘˜é”å®šé®ç½© -->
  <view class="member-lock-overlay" wx:if="{{showMemberLock}}" catchtap="handleLockOverlayTap">
    <view class="lock-content" catchtap="stopPropagation">
      <text class="lock-icon">ğŸ”’</text>
      <text class="lock-title">ä¼šå‘˜ä¸“äº«å†…å®¹</text>
      <text class="lock-desc">åç»­å†…å®¹éœ€è¦å¼€é€šä¼šå‘˜æ‰èƒ½æŸ¥çœ‹</text>
      <view class="lock-buttons">
        <view class="unlock-btn secondary" bindtap="closeMemberLock">
          <text class="unlock-text">ç»§ç»­çœ‹ç¬¬ä¸€é¡µ</text>
        </view>
        <view class="unlock-btn primary" bindtap="goToMemberCenter">
          <text class="unlock-text">ç«‹å³å¼€é€šä¼šå‘˜</text>
        </view>
      </view>
    </view>
  </view>
</view>
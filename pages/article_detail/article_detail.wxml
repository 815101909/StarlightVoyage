<!--pages/article_detail/article_detail.wxml-->
<wxs module="utils">
  function formatTime(seconds) {
    if (!seconds || isNaN(seconds)) return '00:00';
    var mins = Math.floor(seconds / 60);
    var secs = Math.floor(seconds % 60);
    var minStr = mins < 10 ? '0' + mins : mins.toString();
    var secStr = secs < 10 ? '0' + secs : secs.toString();
    return minStr + ':' + secStr;
  }
  
  module.exports = {
    formatTime: formatTime
  };
</wxs>

<view class="article-container">
  <!-- Star background animation -->
  <view class="star-bg"></view>
  
  <!-- Article header with cover -->
  <view class="article-header">
    <view class="header-content">
      <image class="article-cover" 
             src="{{article.coverUrl}}" 
             mode="aspectFill"
             wx:if="{{article.coverUrl}}"
             binderror="handleCoverError"
             lazy-load="{{true}}"></image>
      <view class="article-info">
        <view class="article-title">{{article.title}}</view>
        <view class="article-meta">
          <text class="article-date">{{article.date}}</text>
          <text class="article-tag" wx:if="{{article.category}}">{{article.category}}</text>
        </view>
        <!-- Wavy line divider with å°èˆŸæ‘‡æ˜Ÿæ²³ text -->
        <view class="wavy-divider">
          <view class="wavy-line left"></view>
          <text class="divider-text">å°èˆŸæ‘‡æ˜Ÿæ²³</text>
          <view class="wavy-line right"></view>
        </view>
      </view>
    </view>
  </view>
  
  <!-- Control bar -->
  <view class="control-bar">
    <view class="button-row">
      <!-- æ‰€æœ‰æŒ‰é’®ç»Ÿä¸€æ”¾åœ¨ä¸€èµ· -->
      <view class="left-buttons">
        <view class="action-btn read-btn" bindtap="toggleBgm" hover-class="hover">
          <text class="icon-read">ğŸ”Š</text>
        </view>
        <view class="action-btn bookmark-btn {{isBookmarked ? 'bookmarked' : ''}}" bindtap="bookmarkArticle" hover-class="hover">
          <text class="icon-bookmark">{{isBookmarked ? 'â˜…' : 'â˜†'}}</text>
        </view>
        <view class="action-btn print-btn" bindtap="printArticle" hover-class="hover">
          <text class="icon-print">ğŸ–¨ï¸</text>
        </view>
        <view class="action-btn exercise-btn" bindtap="showExercises" hover-class="hover">
          <text class="icon-exercise">ğŸ“</text>
        </view>
        <view class="action-btn font-decrease-btn" bindtap="decreaseFontSize" hover-class="hover">
          <text>A-</text>
        </view>
        <view class="action-btn font-increase-btn" bindtap="increaseFontSize" hover-class="hover">
          <text>A+</text>
        </view>
      </view>
    </view>
  </view>
  
  <!-- æ€è€ƒé¢˜æ¡† -->
  <view class="thinking-question-box">
    <view class="thinking-question-header">
      <text class="thinking-icon">ğŸ’­</text>
      <text class="thinking-title">æ€è€ƒ</text>
    </view>
    <view class="thinking-question-content">
      <text class="question-text">{{article.thinkingQuestion || 'é€šè¿‡é˜…è¯»æœ¬æ–‡ï¼Œä½ è®¤ä¸ºäººç±»æ¢ç´¢å®‡å®™çš„æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿæœªæ¥çš„å¤ªç©ºæ¢ç´¢ä¼šç»™æˆ‘ä»¬å¸¦æ¥å“ªäº›æ”¹å˜ï¼Ÿ'}}</text>
    </view>
    <view class="thinking-question-tips">
      <text class="tips-text">å°æç¤º: æ€è€ƒè¿™ä¸ªé—®é¢˜å¯ä»¥å¸®åŠ©ä½ æ›´æ·±å…¥åœ°ç†è§£æ–‡ç« å†…å®¹</text>
    </view>
  </view>
  
  <!-- æœ—è¯»æ’­æ”¾å™¨ -->
  <view class="audio-player" wx:if="{{article.voice}}">
    <view class="audio-player-header">
      <text class="audio-title">ğŸ§ æ–‡ç« æœ—è¯»</text>
    </view>
    <view class="audio-controls">
      <view class="audio-info">
        <text class="audio-status">{{article.title}}</text>
      </view>
      <view class="audio-buttons">
        <view class="speed-btn" bindtap="togglePlaybackRate">
          <text class="speed-text">{{playbackRate}}x</text>
        </view>
        <view class="play-btn {{isReading ? 'playing' : ''}}" bindtap="toggleReading">
          <text class="play-icon">{{isReading ? 'âšâš' : 'â–¶'}}</text>
        </view>
      </view>
    </view>
    <!-- è¿›åº¦æ¡å’Œæ—¶é—´æ˜¾ç¤º -->
     <view class="audio-progress">
       <text class="time-text">{{utils.formatTime(audioCurrentTime)}}</text>
       <view class="progress-container">
         <view class="progress-bar">
           <view class="progress-bg"></view>
           <view class="progress-fill" style="width: {{audioProgress}}%"></view>
           <view class="progress-thumb" style="left: {{audioProgress}}%"></view>
         </view>
       </view>
       <text class="time-text">{{utils.formatTime(audioDuration)}}</text>
     </view>
  </view>
  
  <!-- Article content -->
  <view class="article-wrapper" style="position: relative;">
    <scroll-view scroll-y="{{!showMemberLock}}" class="article-content {{showMemberLock ? 'locked' : ''}}" style="font-size: {{fontSize}}rpx">
    <!-- å¼•è¨€éƒ¨åˆ† -->
    <view class="content-box intro-box" style="font-size: {{fontSize}}rpx;" wx:if="{{article.introNodes}}">
      <rich-text nodes="{{article.introNodes}}" class="rich-content" bindtap="onRichTextTap"></rich-text>
    </view>
    <!-- å¼•è¨€å›¾ç‰‡ -->
    <view class="image-group" wx:if="{{article.introImages && article.introImages.length > 0}}">
      <block wx:for="{{article.introImages}}" wx:key="url">
        <image 
          src="{{item.url}}"
          mode="widthFix"
          class="content-image"
          lazy-load="true"
          bindtap="previewImage"
          data-url="{{item.url}}"
        ></image>
        <view class="image-desc-box">{{item.description}}</view>
      </block>
    </view>
    
    <!-- ä¸»è¦å†…å®¹éƒ¨åˆ† -->
    <view class="content-box main-content-box" style="font-size: {{fontSize}}rpx;" wx:if="{{article.contentNodes}}">
      <rich-text nodes="{{article.contentNodes}}" class="rich-content" bindtap="onRichTextTap"></rich-text>
    </view>
    <!-- ä¸»è¦å†…å®¹å›¾ç‰‡ -->
    <view class="image-group" wx:if="{{article.contentImages && article.contentImages.length > 0}}">
      <block wx:for="{{article.contentImages}}" wx:key="url">
        <image 
          src="{{item.url}}"
          mode="widthFix"
          class="content-image"
          lazy-load="true"
          bindtap="previewImage"
          data-url="{{item.url}}"
        ></image>
        <view class="image-desc-box">{{item.description}}</view>
      </block>
    </view>
    
    <!-- ç»“è®ºéƒ¨åˆ† -->
    <view class="content-box conclusion-box" style="font-size: {{fontSize}}rpx;" wx:if="{{article.conclusionNodes}}">
      <rich-text nodes="{{article.conclusionNodes}}" class="rich-content" bindtap="onRichTextTap"></rich-text>
    </view>
    <!-- ç»“è®ºå›¾ç‰‡ -->
    <view class="image-group" wx:if="{{article.conclusionImages && article.conclusionImages.length > 0}}">
      <block wx:for="{{article.conclusionImages}}" wx:key="url">
        <image 
          src="{{item.url}}"
          mode="widthFix"
          class="content-image"
          lazy-load="true"
          bindtap="previewImage"
          data-url="{{item.url}}"
        ></image>
        <view class="image-desc-box">{{item.description}}</view>
      </block>
    </view>
  </scroll-view>
  
  <!-- ä¼šå‘˜é”å®šé®ç½© -->
  <view class="member-lock-overlay" wx:if="{{showMemberLock}}">
    <view class="lock-content">
      <text class="lock-icon">ğŸ”’</text>
      <text class="lock-title">ä¼šå‘˜ä¸“äº«å†…å®¹</text>
      <text class="lock-desc">æŸ¥çœ‹å®Œæ•´æ–‡ç« éœ€è¦å¼€é€šä¼šå‘˜</text>
      <view class="unlock-btn" bindtap="goToMemberCenter">
        <text class="unlock-text">ç«‹å³å¼€é€šä¼šå‘˜</text>
      </view>
    </view>
  </view>
  
  <!-- æ’­æ”¾å™¨å ä½ç©ºç™½åŒºåŸŸ -->
  <view class="player-spacer"></view>
  
  </view>
</view>
<wxs module="utils" src="./profile.wxs"></wxs>

<view class="container profile-page">
  <!-- 星空背景 -->
  <view class="profile-bg"></view>
  
  <!-- 用户信息卡片 -->
  <view class="user-card">
    <view class="avatar-section" bindtap="handleAvatarTap">
      <image wx:if="{{userInfo.avatar}}" class="avatar" src="{{userInfo.avatar}}" mode="aspectFill"></image>
      <view wx:else class="default-avatar" style="background-color: {{defaultAvatarBgColor}};">
        <text class="avatar-text">舟</text>
      </view>
    </view>

    <view class="user-info">
      <!-- 已登录显示用户名 -->
      <view wx:if="{{isLoggedIn}}" class="username">{{userInfo.nickName}}</view>
      <!-- 未登录显示登录按钮 -->
      <view wx:else class="login-btn" bindtap="navigateToLogin">注册/登录</view>
      
      <!-- 已登录显示标签 -->
      <view wx:if="{{isLoggedIn && userInfo.tags.length > 0}}" class="user-tags">
        <view class="user-tag" wx:for="{{userInfo.tags}}" wx:key="*this">{{tagNames[item]}}</view>
      </view>
    </view>

    <view class="edit-profile" bindtap="{{isLoggedIn ? 'editProfile' : 'showLoginTip'}}">编辑</view>
  </view>
  
  <!-- 学习目标卡片 -->
  <view class="goal-card">
    <view class="goal-header">
      <text class="goal-title">我的学习目标</text>
    </view>
    <!-- 已登录且有学习目标时显示 -->
    <view wx:if="{{isLoggedIn && userInfo.learningGoal}}" class="goal-content">
      <text class="goal-icon">🎯</text>
      <text class="goal-content-text">{{goalNames[userInfo.learningGoal]}}</text>
    </view>
    <!-- 已登录但无学习目标 -->
    <view wx:elif="{{isLoggedIn && !userInfo.learningGoal}}" class="goal-content goal-empty">
      <text class="goal-content-text">您还没有设置学习目标，请前往编辑按钮设置～</text>
    </view>
    <!-- 未登录状态 -->
    <view wx:else class="goal-content goal-empty">
      <text class="goal-content-text">请前往编辑按钮中选择学习目标～</text>
    </view>
  </view>
  
  <!-- 功能按钮区域 -->
  <view class="function-container">
    <!-- 收藏按钮 -->
    <view class="function-item" bindtap="showCollectionInfo">
      <text class="function-emoji">⭐</text>
      <text class="function-text">收藏</text>
    </view>
    
    <!-- 客服按钮 -->
    <view class="function-item" bindtap="contactCustomerService">
      <text class="function-emoji">💬</text>
      <text class="function-text">客服</text>
    </view>
    
    <!-- 记录按钮 -->
    <view class="function-item" bindtap="navigateTo" data-path="/pages/record/record">
      <text class="function-emoji">📝</text>
      <text class="function-text">记录</text>
    </view>
    
    <!-- 系统按钮 -->
    <view class="function-item" bindtap="aboutSystem">
      <text class="function-emoji">📱</text>
      <text class="function-text">系统</text>
    </view>
  </view>
  
  <!-- 会员星空许愿按钮 -->
  <view class="action-buttons">
    <view class="action-button full-width membership-button" bindtap="openMemberCenter">
      <image class="action-icon" src="/pages/profile/images/会员中心.jpg" mode="aspectFit"></image>
      <view class="action-content">
        <text class="action-text">会员中心</text>
        <text class="action-desc">{{userInfo.memberLevel > 0 ? '已开通 · 有效期至 ' + utils.formatExpireDate(userInfo.expireDate) : '未开通 · 立即加入会员学习'}}</text>
      </view>
    </view>
    
    <view class="action-button full-width {{hasCheckedInToday ? 'starcard-button' : 'starcard-button-unchecked'}}" bindtap="openStarCheckin">
      <image class="action-icon" src="/pages/profile/images/星空打卡.jpg" mode="aspectFit"></image>
      <view class="action-content">
        <text class="action-text">星空打卡</text>
        <text class="action-desc {{!hasCheckedInToday ? 'unchecked-desc' : ''}}">{{hasCheckedInToday ? '今日已打卡 · 已连续打卡' + userInfo.checkinDays + '天' : '今日未打卡 · 已连续打卡' + userInfo.checkinDays + '天'}}</text>
      </view>
      <view class="checkin-badge" wx:if="{{!hasCheckedInToday}}">今日未打卡</view>
    </view>

    <view class="action-button full-width planet-wheel-button" bindtap="navigateToPlanetWheel">
      <image class="action-icon" src="/pages/profile/images/星球转盘.jpg" mode="aspectFit"></image>
      <view class="action-content">
        <text class="action-text">星空许愿</text>
        <text class="action-desc">星空许愿，标记你的愿望</text>
      </view>
    </view>
  </view>
  
  <!-- 近期活动记录 -->
  <view class="activity-section">
    <!-- 近期活动标题栏 -->
    <view class="section-header">
      <text class="section-title">近期活动</text>
      <text class="view-all" bindtap="showActivityModal">查看全部</text>
    </view>
    
    <view class="activity-list">
      <block wx:if="{{activities.length > 0}}">
        <view wx:for="{{activities}}" wx:key="id" class="activity-item">
          <view class="activity-icon">{{activityIcons[item.type]}}</view>
          <view class="activity-content">
            <view class="activity-title">{{item.title}}</view>
            <view class="activity-time">{{item.time}}</view>
          </view>
        </view>
      </block>
      <view wx:else class="empty-activity">
        <text>暂无活动记录</text>
      </view>
    </view>
  </view>
  
  <!-- 底部设置菜单 -->
  <view class="setting-section">
    <view class="setting-title">设置</view>
    <view class="setting-menu">
      <view wx:if="{{isLoggedIn}}" class="setting-item" bindtap="navigateTo" data-path="/pages/account/account">
        <text class="setting-label">账号与安全</text>
        <text class="setting-value">></text>
      </view>
      <view class="setting-item" bindtap="cleanCache">
        <text class="setting-label">缓存管理</text>
        <text class="setting-value">></text>
      </view>
      <view class="setting-item" bindtap="aboutApp">
        <text class="setting-label">关于小舟摇星河</text>
        <text class="setting-value">></text>
      </view>
      <view wx:if="{{isLoggedIn}}" class="setting-item logout-item" bindtap="logout">
        <text class="setting-label logout-label">退出登录</text>
        <text class="setting-value">></text>
      </view>
    </view>
  </view>
  
  <!-- 底部 -->
  <view class="footer">
    <text class="footer-text">探索星空，记录星际之旅</text>
  </view>
  
  <!-- 加载中状态 -->
  <view class="loading-container" wx:if="{{isLoading}}">
    <view class="loading-icon"></view>
    <text class="loading-text">加载中...</text>
  </view>
</view>

<!-- 活动列表弹窗 -->
<view class="activity-modal {{showAllActivities ? 'show' : ''}}" catchtouchmove="preventTouchMove">
  <view class="activity-modal-mask" bindtap="closeActivityModal"></view>
  <view class="activity-modal-content">
    <view class="activity-modal-header">
      <text class="activity-modal-title">近期活动</text>
      <view class="activity-modal-close" bindtap="closeActivityModal">×</view>
    </view>
    <scroll-view 
      scroll-y 
      class="activity-modal-list" 
      bindscrolltolower="loadMoreActivities"
      lower-threshold="50">
      <view class="activity-item" wx:for="{{allActivities}}" wx:key="id">
        <view class="activity-icon {{item.type}}-icon">{{activityIcons[item.type]}}</view>
        <view class="activity-info">
          <text class="activity-title">{{item.title}}</text>
          <text class="activity-time">{{item.timeStr}}</text>
        </view>
      </view>
      <!-- 加载更多 -->
      <view class="loading-more" wx:if="{{isLoadingMore}}">
        <text class="loading-text">加载中...</text>
      </view>
      <!-- 没有更多数据 -->
      <view class="no-more" wx:if="{{!hasMore && allActivities.length > 0}}">
        <text class="no-more-text">没有更多了</text>
      </view>
    </scroll-view>
  </view>
</view>
